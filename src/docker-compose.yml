version: "3.8"

services:
  # ===========================================================================
  # GitLab CE (source build)
  # ===========================================================================
  gitlab:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gitlab
    hostname: gitlab
    restart: unless-stopped
    ports:
      - "8900:80"
      - "8901:443"
      - "8902:22"
    environment:
      # GitLab core
      GITLAB_HOST: "192.168.3.21"
      GITLAB_PORT: "8900"
      GITLAB_HTTPS: "false"
      GITLAB_SSH_PORT: "8902"

      # PostgreSQL
      DB_ADAPTER: "postgresql"
      DB_HOST: "postgresql"
      DB_PORT: "5432"
      DB_USER: "gitlab"
      DB_PASS: "gitlab"
      DB_NAME: "gitlabhq_production"

      # Redis
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"

      # Initial root password (change for production!)
      GITLAB_ROOT_PASSWORD: "ChangeMe123!"
      GITLAB_ROOT_EMAIL: "admin@local.host"

      # Secrets â€” generate with: openssl rand -hex 64
      GITLAB_SECRETS_DB_KEY_BASE: "5013ff7164b06523fa17596a97c7251a3fa86f95e31d2f978cddc887b95a4f9155220a0daa705684f859c0981df843ccdb415a7722ad2f1b054f2d390077b6f6"
      GITLAB_SECRETS_SECRET_KEY_BASE: "a3570e12ae6d22660cba683d2529465acd14c6e11b05eda46a28b89734c30917a77f49aa4c0cd6e96cd6d2aa3b8a4bf069ce305fd7f2746f6675f50460008058"
      GITLAB_SECRETS_OTP_KEY_BASE: "c0b74cafabd89cf7c712923e290d8271493819a6dc715fe79f8f5484af09f679bd1d0133933a7071cab6ce19cb131a923cb359714540bf307e30519cf6b1a83c"

      # Puma tuning
      PUMA_WORKERS: "2"
      PUMA_MIN_THREADS: "1"
      PUMA_MAX_THREADS: "4"
    volumes:
      - gitlab_repositories:/home/git/repositories
      - gitlab_data:/home/git/data
      - gitlab_shared:/home/git/gitlab/shared
      - gitlab_uploads:/home/git/gitlab/public/uploads
      - gitlab_logs:/home/git/gitlab/log
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    shm_size: "256m"

  # ===========================================================================
  # PostgreSQL 16
  # ===========================================================================
  postgresql:
    image: postgres:16-bookworm
    container_name: gitlab-postgresql
    restart: unless-stopped
    environment:
      POSTGRES_USER: "gitlab"
      POSTGRES_PASSWORD: "gitlab"
      POSTGRES_DB: "gitlabhq_production"
    volumes:
      - postgresql_data:/var/lib/postgresql/data
      - ./init-postgres.sql:/docker-entrypoint-initdb.d/init-postgres.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gitlab -d gitlabhq_production"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ===========================================================================
  # Redis 7
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: gitlab-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

volumes:
  gitlab_repositories:
  gitlab_data:
  gitlab_shared:
  gitlab_uploads:
  gitlab_logs:
  postgresql_data:
  redis_data:
