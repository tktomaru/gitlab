## GitLab CE Nginx configuration
## Based on the official GitLab source installation template

upstream gitlab-workhorse {
    server unix:/home/git/gitlab/tmp/sockets/gitlab-workhorse.socket fail_timeout=0;
}

## Redirect HTTP to HTTPS (disabled â€” HTTP-only setup)
## Uncomment and adjust if you enable SSL
# server {
#     listen 80;
#     server_name YOUR_SERVER_FQDN;
#     return 301 https://$server_name$request_uri;
# }

server {
    listen 80;
    server_name YOUR_SERVER_FQDN;

    server_tokens off;
    root /home/git/gitlab/public;

    ## Real IP (when behind a reverse proxy)
    # real_ip_header X-Real-IP;
    # real_ip_recursive off;

    ## Individual nginx logs for this GitLab vhost
    access_log  /var/log/nginx/gitlab_access.log;
    error_log   /var/log/nginx/gitlab_error.log;

    ## Disable body size limit for large repository pushes
    client_max_body_size 0;

    ## Mask tokens in logs
    ## Prevents private_token, authenticity_token etc from being logged
    log_format gitlab_access '$remote_addr - $remote_user [$time_local] '
                             '"$request_method $gitlab_filtered_request_uri $server_protocol" '
                             '$status $body_bytes_sent '
                             '"$http_referer" "$http_user_agent"';

    ## Filter out sensitive query parameters from logs
    map $request_uri $gitlab_temp_request_uri {
        default $request_uri;
        ~(?i)^(?<start>.*)(?<token>[\?&]private[\-_]token=[^&]*)(?<rest>.*)$ "$start$rest";
    }
    set $gitlab_filtered_request_uri $gitlab_temp_request_uri;

    location / {
        ## Serve static files from defined root folder.
        ## @gitlab is a named location for the upstream fallback, see below.
        try_files $uri /index.html $uri.html @gitlab;
    }

    ## Serve static assets with cache headers
    location ~ ^/(assets)/ {
        root /home/git/gitlab/public;
        gzip_static on;
        expires max;
        add_header Cache-Control public;
    }

    ## Forward requests to gitlab-workhorse
    location @gitlab {
        ## https://github.com/gitlabhq/gitlabhq/issues/694
        ## Some requests take more than 30 seconds.
        proxy_read_timeout      300;
        proxy_connect_timeout   300;
        proxy_redirect          off;

        proxy_http_version 1.1;

        proxy_set_header    Host                $http_host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto   $scheme;

        proxy_pass http://gitlab-workhorse;
    }

    ## WebSocket support for Action Cable
    location /-/cable {
        proxy_pass http://gitlab-workhorse;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 3600;
    }

    ## Enable gzip compression
    location ~ ^/(assets)/ {
        root /home/git/gitlab/public;
        gzip_static on;
        expires max;
        add_header Cache-Control public;
    }

    error_page 404 /404.html;
    error_page 500 /500.html;
    error_page 502 /502.html;
}
